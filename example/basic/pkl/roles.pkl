module roles

import "@ansipkl/AnsibleBuiltin.pkl" as AB
import "@ansipkl/Playbook.pkl" as P

docker = P.NewRole(new Listing {
    new AB.Apt {
        name = "install ca-certs for docker"
        options {
            state = "present"
            name {
                "ca-certificates"
            }
        }
    }.Task()

    new AB.GetUrl {
        name = "download docker apt keyrings"
        options {
            url = "https://download.docker.com/linux/debian/gpg"
            dest = "/etc/apt/keyrings/docker.asc"
        }
    }.Task()

    new AB.AptRepository {
        name = "configure docker apt repository"
        options {
            repo = "deb [arch=amd64 signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/debian {{ ansible_distribution_release }} stable"
            state = "present"
        }
        register = "repo"
    }.Task()

    new AB.Apt {
        name = "install ca-certs for docker"
        options {
            state = "present"
            name {
                "docker-ce"
                "docker-ce-cli"
                "containerd.io"
                "docker-buildx-plugin"
                "docker-compose-plugin"
            }
        }
        `when` = "repo.changed"
    }.Task()
})
